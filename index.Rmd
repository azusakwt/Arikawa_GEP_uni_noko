---
title: "Explanation of GEP, PPFD, Temperature model"
subtitle: "Arikawa Bay, Nagasaki, Japan"  
author: 
  - "Gregory N. Nishihara"
  - "Azusa Kawate"
date: 'Updated `r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color = "#1381B0",
  secondary_color = "#FF961C",
  inverse_header_color = "#FFFFFF"
)
```

class: middle, center
# 藻類学会用モデル

---

## 一般化線形モデル

$$
\log(\mu) = \mathbf{X} \beta  + \beta_L L
$$


$$
\mathbf{X} = 
\begin{bmatrix}
1 & P & T & S & P \times T & P \times S & T \times S & P \times T \times S
\end{bmatrix}
$$

$$
\beta^T = 
\begin{bmatrix}
\beta_0 & \beta_P & \beta_T & \beta_S & \beta_{P\times T} & \beta_{P\times S} & \beta_{T\times S} & \beta_{P\times T\times S}
\end{bmatrix}
$$

**分布モデル**

$$
y \sim \Gamma(\mu / \theta, \theta)
$$

**記号について**

.pull-left[

* $y$: 観測値 (GEP)
* $\mu$: 期待値
* $\theta$: 尺度
* $\mathbf{X}$: デサイン行列
* $\Gamma(\cdot)$: ガンマ分布
]
.pull-right[

* $\beta$: モデル係数
* $P$, $T$: 光量子量 (P), 水温 (T), 状態 (S), 生態系 (L)
* $S$: 状態 (S) = {Desertified, Vegetated}
* $L$: 生態系 (L) = {Sargassum, Zostera}
]


---

## 事前分布

$$
\begin{aligned}
\beta &\sim N(0, 1) \\
\beta_L &\sim N(0, 1) \\
\sigma &\sim N(0, 1) \\
\theta &\sim N(0, 1) \\
\end{aligned}
$$

---
## BRMS Model

藻類学会用モデルは階層ベイズではない。階層ベイズモデルも実行したが、ほとんど変わらない。

```{r, eval = FALSE}
gepmodel  = bf(GEP ~ PPFD * TEMP * state + location) + Gamma("log")
CTRL = list(adapt_delta = 0.95, max_treedepth = 15)

PRIOR = get_prior(gepmodel, data = dset) %>% 
  mutate(prior = ifelse(str_detect(class, "b|Intercept|b"), "normal(0, 1)", prior)) %>% 
  mutate(prior = ifelse(str_detect(class, "sd"), "normal(0, 1)", prior)) %>% 
  mutate(prior = ifelse(str_detect(class, "shape|sigma"), "normal(0, 1)", prior)) %>% 
  filter(str_detect(coef, "^s\\(", negate = T))

```

---


class: middle, center
# Multilevel model

## Not ready.

---

## The linear model

$$
\begin{aligned}
\log(\mu_{P}) &= f_{P}^{cc}(M_{[i]}) + f_{P}^{tp}(M_{[i,j]}) + f_{P}^{tp}(M_{[i,k]}) +  S_{\mu_P[j]} +  L_{\mu_P[k]} + U_{P[j,k]} + V_{P[i,j,k]}\\
\mu_{T} &= f_{T}^{cc}(M_{[i]}) + f_{T}^{tp}(M_{[i,j]}) + f_{T}^{tp}(M_{[i,k]}) +  S_{\mu_T[j]} +  L_{\mu_T[k]} + U_{T[j,k]} + V_{T[i,j,k]}\\
\log(\mu_{G}) &=   \beta_{P[j,k]} \mu_P + \beta_{T[j,k]} \mu_T +S_{\mu_G[j]} + L_{\mu_G[j,k]} + U_{G[j,k]}\mu_P + V_{G[j,k]}\mu_T + W_{G[i,j,k]}\\
\end{aligned}
$$
**Distribution for observations**

$$
\begin{aligned}
y_P &\sim \Gamma(\mu_P / \theta_P, \theta_P) \\
y_T &\sim N(\mu_T, \sigma_T) \\
y_G &\sim \Gamma(\mu_G / \theta_G, \theta_G) \\
\end{aligned}
$$

.pull-left[

* $P$, $T$, $G$: PPFD, Temperature, and GEP
* $M$, $S$, $L$: $i$ Months,  $j$ States, and $k$ Locations
* $f^{cc}()$, $f^{tp}()$: Cyclic cubic spline and Thin-plate spline

]

.pull-right[
* $y_P$, $y_T$, $y_G$: Observations
* $\theta$, $\sigma$: Scale parameters
* $\mu$:  Location parameter
* $U_P$, $U_T$: Variance between Site and Location
* $V_P$, $V_T$, $W_G$: Variance between Month, Site, and Location
]

---

## The population and group level effects

$$
\begin{aligned}
\theta_P, \theta_G, \sigma_T       &\sim N(0, 1) \\
S, L &\sim N(0, 1) \\
U, V, W &\sim N(0, 1) \\
  \begin{bmatrix} \beta_{P} \\  \beta_{T}\\ \end{bmatrix} &\sim MVN \left(\begin{bmatrix} \beta_{P} \\ \beta_{T} \\ \end{bmatrix}, \Sigma\right) \\
\end{aligned}
$$


---

## BRMS Model

```{r, eval = FALSE}
ppfdmodel = bf(PPFD  ~ s(month, k = 4, bs = "cc") + s(month, by = state) + 
                 state + (0+1|state) +  (0+1|month/state)) + Gamma("log")
tempmodel = bf(TEMP  ~ s(month, k = 6, bs = "cc") + s(month, by = state) + s(month, by = location) + 
                 state + location + (0+1|state/location) + (0 + 1|month/state/location)) + gaussian()
gepmodel  = bf(GEP ~ PPFD + TEMP + state + location + 
                 (0+PPFD+TEMP|state/location) + (0 + 1|month/state/location)) + Gamma("log")
```


```{r, eval = FALSE}

PRIORS = get_prior(completemodel, data = dset) %>% 
  mutate(prior = ifelse(str_detect(class, "b|Intercept|b"),
                        "normal(0, 1)", prior)) %>% 
  mutate(prior = ifelse(str_detect(class, "sd"),
                        "normal(0, 1)", prior)) %>% 
  mutate(prior = ifelse(str_detect(class, "shape|sigma"),
                        "normal(0, 1)", prior)) %>% 
  filter(str_detect(coef, "^s\\(", negate = T))

```

